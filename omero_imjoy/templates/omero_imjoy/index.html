<!DOCTYPE html>
<!-- From https://github.com/imjoy-team/imjoy-core/blob/master/src/core-example.html -->
<html lang="en">

<head>
    <title>OMERO-ImJoy</title>

    <meta charset="utf-8" />
    <meta name="viewport"
        content="width=device-width, height=device-height, initial-scale=1, maximum-scale=1, user-scalable=no" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="description" content="ImJoy -- Deep Learning Made Easy!" />
    <meta name="author" content="Wei OUYANG" />
    <meta name="keywords" content="Bioimaging, image processing" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:site" content="@weioyang" />
    <meta name="twitter:creator" content="@weioyang" />
    <meta name="twitter:image" content="https://imjoy.io/static/img/imjoy-card-plain.png" />
    <meta property="og:url" content="https://imjoy.io" />
    <meta property="og:title" content="ImJoy" />
    <meta property="og:description" content="ImJoy -- Deep Learning Made Easy!" />
    <meta property="og:image" content="https://imjoy.io/static/img/imjoy-card-plain.png" />
    <meta name="format-detection" content="telephone=no" />
    <link rel="apple-touch-icon" sizes="57x57" href="https://imjoy.io/static/icons/apple-icon-57x57.png" />
    <link rel="apple-touch-icon" sizes="60x60" href="https://imjoy.io/static/icons/apple-icon-60x60.png" />
    <link rel="apple-touch-icon" sizes="72x72" href="https://imjoy.io/static/icons/apple-icon-72x72.png" />
    <link rel="apple-touch-icon" sizes="76x76" href="https://imjoy.io/static/icons/apple-icon-76x76.png" />
    <link rel="apple-touch-icon" sizes="114x114" href="https://imjoy.io/static/icons/apple-icon-114x114.png" />
    <link rel="apple-touch-icon" sizes="120x120" href="https://imjoy.io/static/icons/apple-icon-120x120.png" />
    <link rel="apple-touch-icon" sizes="144x144" href="https://imjoy.io/static/icons/apple-icon-144x144.png" />
    <link rel="apple-touch-icon" sizes="152x152" href="https://imjoy.io/static/icons/apple-icon-152x152.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="https://imjoy.io/static/icons/apple-icon-180x180.png" />
    <link rel="icon" type="image/png" sizes="192x192" href="https://imjoy.io/static/icons/android-icon-192x192.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="https://imjoy.io/static/icons/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="96x96" href="https://imjoy.io/static/icons/favicon-96x96.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="https://imjoy.io/static/icons/favicon-16x16.png" />
    <link rel="shortcut icon" href="static/icons/favicon.ico" type="image/x-icon" />
    <link rel="icon" href="static/icons/favicon.ico" type="image/x-icon" />
    <link rel="apple-touch-startup-image" href="/launch.png" />
    <link rel="manifest" href="manifest.json" />
    <meta name="msapplication-TileColor" content="#f5f9ff" />
    <meta name="msapplication-TileImage" content="static/icons/ms-icon-144x144.png" />
    <meta name="theme-color" content="#f5f9ff" />

    <script src="https://lib.imjoy.io/imjoy-loader.js"></script>
    <link rel="stylesheet" href="https://lib.imjoy.io/static/joy.css" />
    <link rel="stylesheet" href="https://static.imjoy.io/spectre.css/spectre.min.css" />
    <link rel="stylesheet" href="https://static.imjoy.io/spectre.css/spectre-exp.min.css" />
    <link rel="stylesheet" href="https://static.imjoy.io/spectre.css/spectre-icons.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.15.3/axios.min.js"></script>

    <!-- Relative links allows testing without Django -->
    <!-- When served by Django, the URLs will be updated -->
    <script src="../../static/omero_imjoy/util.js"></script>
    <script src="../../static/omero_imjoy/imjoy.js"></script>
    <link rel="stylesheet" href="../../static/omero_imjoy/imjoy.css">
</head>

<body>
    <div class="modal" id="dialog-container">
        <a href="#" class="modal-overlay" aria-label="Close"></a>
        <div class="modal-container">
            <div class="modal-header">
                <a href="#" class="btn btn-clear float-right" aria-label="Close" onclick="closeDialog()"></a>
                <div class="modal-title h5" id="window-dialog-title">Dialog</div>
            </div>
            <div class="modal-body">
                <div class="content">
                    <div id="window-dialog-container"></div>
                </div>
            </div>
        </div>
    </div>
    <header class="navbar">
        <section class="navbar-section" id="logo">
            <a href="/">
                <img class="site-title-small" src="https://imjoy.io/static/img/imjoy-logo-black.svg" alt="ImJoy" />
            </a>
            <!-- <a href="https://imjoy.io/docs" target="_blank" class="btn btn-link">Docs</a>
            <a href="https://github.com/imjoy-team/ImJoy" target="_blank" class="btn btn-link">GitHub</a> -->
        </section>
        <section class="navbar-section" id="windows-menu" style="flex: 0 1 0;">
            <div class="dropdown dropdown-right">
                <a class="btn btn-sm more-btn dropdown-toggle" tabindex="0"><i class="icon icon-more-horiz"></i></a>
                <ul class="menu" id="plugin-menu"></ul>
            </div>
        </section>
        <progress class="progress" style="display: none;" id="progress" value="100" max="100"></progress>
    </header>
    <div class="loading loading-lg floating" id="loading"></div>
    <div class="whiteboard" id="whiteboard">
        <img src="https://imjoy.io/static/img/imjoy-io-icon.svg" id="empty-img" />
    </div>

    <script>

        document.addEventListener("DOMContentLoaded", async event => {
            // pin the version
            window.imjoyCore = await loadImJoyCore({ version: "0.13.60" });
            imjoy = new imjoyCore.ImJoy({
                imjoy_api: imjoy_api,
            });
            imjoy.event_bus.on("show_message", msg => {
                console.log(msg);
            });
            imjoy.event_bus.on("add_window", async w => {
                if (w.fullscreen || w.standalone) {
                    document.querySelector(".navbar").style.height = "2px";
                    document.getElementById("logo").style.display = "none";
                    // document.getElementById("windows-menu").style.display = "none";
                } else {
                    document.querySelector(".navbar").style.height = "32px";
                    document.getElementById("logo").style.display = "flex";
                }
                addWindow(w);
            });
            const workspace = getUrlParameter("workspace") || getUrlParameter("w");
            const token = getUrlParameter("token") || getUrlParameter("t");
            const engine = getUrlParameter("engine") || getUrlParameter("e");


            await imjoy.start({ workspace: workspace });
            console.log("ImJoy started: ", imjoy);
            let p = getUrlParameter("plugin") || getUrlParameter("p");
            console.log({p, workspace});
            if (!p && workspace) {
                document.getElementById("loading").style.display = "none";
                return;
            }
            window.loadPlugin = function(p) {
                if (!p)
                    p = prompt(
                    `Please type a ImJoy plugin URI to start or pass it with ${window
                        .location.href + "?plugin=PLUGIN_URI"}`,
                    ""
                    );
                if (!p) return;
                document.getElementById("loading").style.display = "block";
                imjoy.pm
                    .reloadPluginRecursively({ uri: p })
                    .then(async plugin => {
                    let config = {};
                    if (plugin.config.ui && plugin.config.ui.indexOf("{") > -1) {
                        config = await imjoy.pm.imjoy_api.showDialog(
                        plugin,
                        plugin.config
                        );
                    }
                    await plugin.api.run({ config: config, data: {} });
                    document.getElementById("loading").style.display = "none";
                    })
                    .catch(e => {
                    console.error(e);
                    alert(`failed to load the plugin, error: ${e}`);
                    document.getElementById("loading").style.display = "none";
                    });
            };

            if (engine) {
                try {
                    console.log("Loading Jupyter-Engine-Manager from Gist...");
                    await imjoy.pm.reloadPluginRecursively({
                        uri:
                            "https://imjoy-team.github.io/jupyter-engine-manager/Jupyter-Engine-Manager.imjoy.html",
                    });
                    console.log("Jupyter-Engine-Manager loaded.");
                    const factory = imjoy.em.getFactory("Jupyter-Engine");
                    await factory.addEngine({ url: engine, token: token });
                    console.log("plugin engine added:", engine);
                } catch (e) {
                    console.error(e);
                    alert(`Failed to connect to the engine: ${e}`);
                }
            }

            if (p) {
                window.loadPlugin(p);
            }

            imjoy.event_bus.on("plugin_loaded", plugin => {
                //reload the plugin menu
                var plugin_menu = document.getElementById("plugin-menu");
                plugin_menu.innerHTML = "";
                for (let pn in imjoy.pm.plugin_names) {
                    plugin_menu.innerHTML =
                        `
                    <li class="menu-item"><a href="#" onclick='runPlugin("${pn.replaceAll("'", "`")}")'>${pn}</a></li>
                    ` + plugin_menu.innerHTML;
                }
                plugin_menu.innerHTML =
                    plugin_menu.innerHTML +
                    '<li class="menu-item"><a href="#" onclick="loadPlugin()"><i class="icon icon-plus"></i>&nbsp;Load Plugin</a></li>';
                plugin_menu.innerHTML =
                    plugin_menu.innerHTML +
                    '<li class="menu-item"><a href="#" onclick="window.onresize()"><i class="icon icon-stop"></i>&nbsp;Cancel</a></li>';
            });

            window.runPlugin = name => {
                imjoy.pm.plugin_names[name.replaceAll("`", "'")].api.run({ config: {}, data: {} });
            };


            async function handleImageIds(image_ids) {
                // image_ids.forEach((image_id) => {
                const image_id = image_ids[0];
                console.log('image_id', image_id);
                // Load image json...

                const zarr = await import('https://unpkg.com/@manzt/zarr-lite/index.js')
                const HTTPStore = await getStore()
                // Test sample image:
                const zarr_url = "https://s3.embassy.ebi.ac.uk/idr/zarr/v0.1/6001240.zarr"
                // const zarr_url = `${ getBaseUrl() }/imjoy/zarr/${ image_id }/`

                async function loadPyramid() {
                    const store = new HTTPStore(zarr_url);
                    const rootAttrs = await zarr.getJson(store, '.zattrs');
                    console.log('rootAttrs', rootAttrs);
                    let paths = [];
                    if ('multiscales' in rootAttrs) {
                        const {
                            datasets
                        } = rootAttrs.multiscales[0];
                        paths = datasets.map(d => d.path);
                    }
                    const p = paths.map(path => zarr.openArray({
                        store,
                        path
                    }));
                    return Promise.all(p);
                }

                const pyramid = await loadPyramid();
                const zarr_arr = pyramid[0]

                console.log('zarr_arr', zarr_arr);
                let [sizeT, sizeC, sizeZ, sizeY, sizeX] = zarr_arr.shape;

                // FIXME: Ignore sizeT for now
                const zarrData = await Promise.all(
                    range(sizeZ).flatMap(z => {
                        return (range(sizeC).map(c => {
                            return zarr_arr.getRawChunk([0, c, z, 0, 0])
                        }))
                    })
                );
                console.log('zarrData', zarrData)

                // 3 channels viewed separately
                // merge into one array
                const zarrPlanes = mergeArrays(zarrData.map(d => d.data));
                console.log('zarrPlanes', zarrPlanes);

                // init ImageJ viewer
                const ij = await imjoy.pm.imjoy_api.createWindow(null, { src: "https://ij.imjoy.io" })

                ij.viewImage({ _rtype: 'ndarray', _rdtype: 'uint16', _rshape: [sizeZ * sizeC, sizeY, sizeX, 1], _rvalue: zarrPlanes.buffer });

                document.getElementById("loading").style.display = "none";
            }


            // Use ?image=1 to open an OMERO Image
            const image_ids = getUrlParameterList("image");

            if (image_ids.length > 0) {
                handleImageIds(image_ids);
            }

        });
        // fix mobile display
        window.onresize = () => {
            document.body.height = window.innerHeight;
            document
                .getElementById("whiteboard")
                .style.setProperty("height", window.innerHeight + "px", "important");
        };
        window.onresize();
    </script>

</body>

</html>